## gazebo中不同控制接口的对比以及其他注意事项

在gazebo的使用过程中，发现两个问题。

1. 机器人控制接口和PID参数配置不合理导致在重力作用下下降，如机械臂不能保持水平；
2. 质量和惯量配置不合理导致的机器人倾覆问题；

### 控制接口和PID参数

gazebo目前提供的接口有三种，分别是力矩接口，速度接口和位置接口。该接口表示的是机器人关节可以接收的指令形式，对于力矩接口，机器人关节接收力矩输入，如果用户输入力矩，则gazebo直接将该力矩驱动电机，如果用户输入速度或者位置，那么需要通过PID参数将用户输入转换成力矩来控制电机。

#### 三种接口的表现形式

1. 力矩接口：在不加载控制器的情况下，每个关节的默认力矩是0，那么肯定不能抵抗重力；为保持机器人稳定，外环需要有位置控制器，并且要根据具体机器人合理调整PID参数，否则机器人运动会比较奇怪；
2. 速度接口：在不加载控制器的情况下，每个关节的默认速度是0，但是因为有噪声的存在，表现的结果是位置偏移，即在重力作用下下降；为保持机器人稳定，外环需要有位置控制器，并且要根据具体机器人合理调整PID参数，否则机器人运动会比较奇怪；
3. 位置接口：默认情况下就存在位置外环，因此机器人不会在重力作用下下降，表现稳定。

#### 三种接口对比

1. 力矩接口：最符合物理机器人的接口形式，但是因为机器人的非线性太强，调整PID参数时会花费一定的功夫；如果不是想验证机器人某些动力学性能，不推荐使用（另一方面，如果真的想验证动力学性能，gazebo提供的动力学模型足够吗？）
2. 速度接口：缺点和上面一样。如果在gazebo底层控制器中设置了PID参数，会将输入的速度转换成力矩，如果没设置PID参数，则在满足最大力矩约束的前提下，以目标速度驱动关节（默认没有配置gazebo的PID参数）；
3. 位置接口：好处是不需要设置PID参数，调试简单；和速度接口一样，如果在gazebo底层控制器接口中设置了PID参数，会将输入的位置转换成力矩控制机器人，如果没配置，会以最大扭矩驱动机器人（则机器人会以最大速度运动），表现的形式可能是运动不平滑。

#### 接口选择

目前来讲，位置接口是最简单易用的形式，不需要花时间调试PID参数，唯一的缺点是需要根据位置接口模拟出速度接口。同时机器人会以最大速度驱动关节，机器人运动看上去会不平滑。这个问题可以通过降低关节的最大速度，或者提高速度接口的发送频率来在一定程度上解决。

### 质量和惯量配置

gazebo作为一个带有物理引擎的系统，如果惯量配置不合理，机器人肯定会发生倾覆。比如在移动机器人上放置一个机械臂，可能就会倾覆。

一种解决办法是为每个连杆设置合理的质量，惯量，连杆摩擦，关节摩擦等，尽量逼近真实的机器人。但是这项工作太繁琐。

第二种方式是添加一个全局的坐标系`world`，并且将机器人通过平移旋转或者固定关节与`world`连接起来，同时结合关节位置控制接口，即可实现稳定的仿真。

另外，如果添加了虚拟连杆，同时某一个活动关节又依赖该连杆，则必须为连杆配置惯量参数，否则控制器加载失败。

最后，在gazebo7中，移动机器人y方向的控制器有时候不起作用，在gazebo9中就不会出现该问题。

张恒
2021.9.2